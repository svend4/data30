# Руководство по использованию макросов

## Назначение

Макросы описывают повторяемые сценарии в стандартизированном формате, чтобы их можно было быстро внедрять, проверять и поддерживать.

## Утверждённый формат

Единый формат макроса: **Trigger → Steps → Conditions → Errors → Result**.

Подробная структура и обязательные поля описаны в `docs/macros/spec.md`.

## Быстрый старт

1. Выберите шаблон из `templates/macros.yaml`.
2. Скопируйте нужный макрос и заполните параметры.
3. Проверьте соответствие `schemas/macro.schema.json`.
4. Проведите тестовый запуск и обновите блок `reliability`.

## Хранение

- Рекомендуемый формат — **YAML** для удобства чтения и редактирования.
- Валидация выполняется JSON Schema (подходит и для YAML).
- Все обязательные поля должны присутствовать, дополнительные поля запрещены.

## Параметризация

Параметры описывают, что пользователь может менять без кода. Обычно это:

- каналы и адресаты уведомлений;
- пороги (минимальная сумма, критичность, SLA);
- шаблоны сообщений и документов;
- внешние endpoints и токены доступа;
- списки команд, чеклистов, ролей.

Пример параметров:

- адресатов уведомлений
- пороги (минимальная сумма, критичность)
- шаблоны сообщений
- внешние endpoints
- расписание или событие триггера
- локальные маршрутизации (команды, очереди)
- лимиты и фильтры для выборок
```yaml
parameters:
  - name: "routing_table"
    type: "string"
    required: true
    description: "Идентификатор таблицы маршрутизации"
  - name: "min_score"
    type: "number"
    required: true
    default: 0.6
```

Подставляйте параметры в шагах и условиях как `{{parameter_name}}`.

## Метрики качества

Для оценки качества используйте минимум:

- **Время настройки** — среднее время до первого успешного запуска и число итераций правок.
- **Стабильность** — доля успешных запусков, частота ошибок, среднее число ретраев.
- **Процент успешных запусков** — Success Rate за последние N запусков.

## Надёжность

Блок `reliability` отражает доверие к макросу.

Рекомендации:

- обновляйте `score` после тестов или инцидентов;
- фиксируйте причины в `basis`;
- отмечайте `failure_rate` и уровень автоматизации.

## Метрики качества

`quality_metrics` фиксирует три ключевые метрики:

- время настройки (минуты),
- стабильность (`low`/`medium`/`high`),
- процент успешных запусков.

## Проверка качества

Перед вводом в эксплуатацию убедитесь:

- Заполнены все обязательные поля.
- `steps` имеют логичную последовательность.
- Все параметры описаны и используются.
- Есть обработка ожидаемых ошибок.

## Уровни зрелости

Используйте уровни зрелости для таблицы и каталога:

- **Прототип** — низкая стабильность или ограниченное покрытие.
- **Стабильный** — проверен в реальных запусках, приемлемый риск.
- **Рекомендованный** — высокая стабильность, подтверждённые метрики.

## Каталог макросов (ключевые сценарии)

| Макрос | Сценарий | Описание | Уровень зрелости |
| --- | --- | --- | --- |
| `support_ticket_triage` | Поддержка | Классификация тикетов и назначение приоритета. | Рекомендованный |
| `invoice_reminder` | Финансы | Напоминания о просроченных счетах. | Рекомендованный |
| `onboarding_checklist` | HR | Создание задач онбординга сотрудника. | Стабильный |
| `weekly_metrics` | Аналитика | Сбор KPI и рассылка отчёта. | Стабильный |
| `incident_status_update` | SRE | Публикация статуса инцидента. | Стабильный |
| `contract_review` | Юристы | Проверка договора по чеклисту. | Прототип |
| `marketing_brief` | Маркетинг | Сбор требований и формирование брифа. | Стабильный |
| `knowledge_base_update` | Поддержка | Создание статьи базы знаний после инцидента. | Стабильный |
| `sales_lead_enrichment` | Продажи | Обогащение лида через внешние источники. | Прототип |
| `shipment_tracking` | Логистика | Обновление статуса доставки и уведомление. | Стабильный |
| `access_review` | Безопасность | Квартальный пересмотр доступов. | Рекомендованный |
| `content_publish` | Контент | Ревью и публикация контента. | Стабильный |
| `customer_nps` | Клиентский опыт | Отправка опроса NPS после заказа. | Стабильный |
| `data_retention_cleanup` | Комплаенс | Очистка данных по сроку хранения. | Рекомендованный |

Полный список и структура — в `templates/macros.yaml`.

## Правила обновления макросов

1. **Версионирование** — меняйте `version` при каждом изменении логики, условий или параметров.
2. **Совместимость** — при критичных изменениях сохраняйте предыдущую версию до миграции.
3. **Ревью** — любые изменения проходят проверку владельца сценария.
4. **Тесты** — фиксируйте результаты тестового запуска и обновляйте `reliability`.
5. **История изменений** — храните ссылку на заявку/тикет в описании или `basis`.
6. **Снятие с эксплуатации** — помечайте устаревшие макросы и указывайте замену.

## Частые сценарии

Список готовых шаблонов включает:

- триаж тикетов
- напоминания об оплате
- онбординг сотрудника
- отчеты по метрикам
- публикация контента

Полный список — в `templates/macros.yaml`.

## Каталог MVP-макросов

Уровни зрелости: **MVP** — пригоден для пилота; **Pilot** — проверен на ограниченном объеме; **Stable** — отработан в проде.

| Макрос | Сценарий | Описание | Уровень зрелости |
| --- | --- | --- | --- |
| `support_ticket_triage` | Поддержка | Классификация тикетов и назначение приоритета | Pilot |
| `invoice_reminder` | Биллинг | Напоминания по неоплаченным счетам | Stable |
| `onboarding_checklist` | HR | Создание задач для онбординга | Pilot |
| `weekly_metrics` | Аналитика | Сбор KPI и рассылка отчета | Pilot |
| `incident_status_update` | SRE | Публикация статуса инцидента | Pilot |
| `contract_review` | Legal | Проверка договора по чеклисту | MVP |
| `marketing_brief` | Маркетинг | Сбор и формирование брифа | MVP |
| `knowledge_base_update` | Поддержка | Обновление базы знаний по инциденту | Pilot |
| `sales_lead_enrichment` | Sales | Обогащение лида через API | MVP |
| `shipment_tracking` | Логистика | Проверка доставки и уведомления | Pilot |
| `access_review` | Security | Квартальный пересмотр доступов | Stable |
| `content_publish` | Контент | Проверка и публикация в CMS | Pilot |
| `customer_nps` | Клиентский опыт | Сбор NPS после заказа | Pilot |
| `data_retention_cleanup` | Комплаенс | Очистка данных по политике хранения | Stable |

## Правила добавления и обновления макросов

1. Опишите макрос по структуре Trigger → Steps → Conditions → Errors → Result.
2. Заполните `parameters`, `quality_metrics`, `reliability` и `result`.
3. Проверьте соответствие `schemas/macro.schema.json` (валидация обязательна).
4. При изменении логики увеличьте `version` и обновите метрики качества/надёжности.
5. Проведите тестовый запуск и задокументируйте результаты в `basis`/`signals`.
6. Обновите каталог MVP-макросов и шаблон в `templates/macros.yaml`.
