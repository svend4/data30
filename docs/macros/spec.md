# Формат и модель данных макросов

Этот документ фиксирует структуру макроса и требования к данным.

Макрос — это формализованный сценарий автоматизации, который связывает триггер, действия и ожидаемый результат в единый повторяемый процесс. Он нужен, чтобы быстро внедрять типовые операции, обеспечивать их воспроизводимость и контролируемое качество.

Макросы позволяют документировать бизнес-логику без кода: пользователи настраивают параметры, а команда поддерживает единый формат описания, что упрощает проверку, масштабирование и повторное использование.

## 1. Формат макроса (триггер → шаги → условия → ошибки → результат)

Каждый макрос описывает автоматизируемый сценарий в виде пяти логических блоков:

1. **Триггер** — событие или условие старта.
2. **Шаги** — упорядоченная последовательность действий.
3. **Условия** — правила выполнения/ветвления.
4. **Ошибки** — ожидаемые сбои и обработка.
5. **Результат** — ожидаемый выход и артефакты.

Структура макроса утверждена в виде последовательности: **Trigger → Steps → Conditions → Errors → Result**.

### Обязательные поля

- `id`: уникальный идентификатор макроса.
- `name`: короткое имя сценария.
- `description`: цель и контекст использования.
- `trigger`: объект триггера.
- `steps`: массив шагов.
- `conditions`: массив условий.
- `errors`: массив описаний ошибок.
- `result`: объект результата.
- `parameters`: массив параметров, задаваемых пользователем.
- `quality_metrics`: метрики качества макроса.
- `reliability`: блок оценки надёжности.
- `version`: версия описания макроса.

### Триггер

`trigger` фиксирует, когда макрос запускается.

Пример:

```yaml
trigger:
  type: manual
  event: "user_request"
  description: "Пользователь вручную запускает макрос"
```

### Шаги

`steps` — массив объектов, каждый шаг содержит:

- `id`: локальный идентификатор.
- `action`: тип действия (например, `read`, `write`, `notify`, `call_api`).
- `inputs`: входные данные (могут ссылаться на параметры).
- `outputs`: описания результатов шага.
- `notes`: уточнения для исполнителя.

### Условия

`conditions` описывает ветвление или проверки:

- `id`
- `expression`: читаемое правило (например, `order.status == "paid"`).
- `on_true` / `on_false`: ссылки на шаги или действия.

### Ошибки

`errors` описывает ожидаемые сбои и реакцию:

- `code`
- `message`
- `mitigation`: как реагировать (повтор, уведомление, фолбэк).

### Результат

`result` фиксирует выходные данные:

- `summary`
- `artifacts`: массив артефактов, создаваемых макросом.
- `success_criteria`: критерии успешного завершения.

## 2. Параметризация

Параметры задаются в `parameters` и отражают, что пользователь может изменить без кода.

Каждый параметр содержит:

- `name`
- `type` (`string`, `number`, `boolean`, `array`, `object`)
- `required`
- `default`
- `description`
- `example`

### Использование параметров

Внутри `inputs`/`conditions` параметр указывается как `{{parameter_name}}`.

## 3. Оценка надёжности

Блок `reliability` нужен для оценки риска использования макроса.

Формат:

```yaml
reliability:
  score: 0.82
  confidence: "medium"
  basis:
    - "Успешно проверен в QA 5 раз"
    - "Есть мониторинг ключевых шагов"
  last_reviewed: "2025-02-01"
  signals:
    automation_level: "semi"
    failure_rate: 0.06
    coverage: "partial"
```

### Подсказки для расчёта

- `score` — число 0.0–1.0.
- `confidence`: `low`/`medium`/`high`.
- `signals` — вспомогательные метрики (например, доля неуспешных запусков).

## 4. Метрики качества макроса

`quality_metrics` отражает затраты на настройку и фактическое качество работы макроса.

Формат:

```yaml
quality_metrics:
  setup_time_minutes: 35
  stability: "medium"
  success_rate: 0.92
```

- `setup_time_minutes` — оценка времени настройки в минутах.
- `stability` — субъективная стабильность: `low`/`medium`/`high`.
- `success_rate` — доля успешных запусков (0.0–1.0).

## 5. Формат хранения и правила валидации

- Допускаются **YAML** и **JSON** (рекомендуется YAML для работы вручную).
- Валидация выполняется JSON Schema из `schemas/macro.schema.json`.
- Все обязательные поля должны присутствовать; неизвестные поля запрещены (`additionalProperties: false`).
- Значения метрик (`score`, `success_rate`, `failure_rate`) проверяются на диапазон 0–1.
- При обновлении макроса увеличивайте `version` и фиксируйте обновление метрик.

## 6. Ссылки на схему

Официальная схема валидации хранится в `schemas/macro.schema.json`.
