# ADR-0001: Выбор хранилища для модели связей

* Статус: принят
* Дата: 2025-01-01

## Контекст
Нужно выбрать хранилище для данных о сущностях (Function/Module/UseCase) и их связях, а также обеспечить поиск по версиям и метаданным.

## Требования к типам запросов
* Поиск связей между Function/Module/UseCase:
  * транзитивные связи (например, «какие UseCase используют Function через Module»),
  * поиск кратчайших/ограниченных путей,
  * агрегации по типам связей.
* Фильтрация по версиям и окружениям:
  * выборка актуальной версии на дату,
  * дифф версий (что изменилось в связях),
  * фильтры по тегам/атрибутам.
* Комбинация графовых и табличных выборок:
  * соединение связей с табличными атрибутами,
  * фильтрация по полям метаданных.
* Экспорт и аналитика:
  * формирование отчетов по покрытиям,
  * выборки для BI/аналитики.

## Рассмотренные варианты
### 1) Графовая БД (Neo4j/ArangoDB)
**Плюсы**
* Нативные графовые запросы (path queries, shortest path).
* Простая модель для связей между сущностями.

**Минусы**
* Дополнительная инфраструктура и интеграция.
* Сложнее совмещать графовые запросы с табличной аналитикой.
* Нужны отдельные механизмы для строгих транзакций и схемной эволюции.

### 2) Реляционная БД (PostgreSQL)
**Плюсы**
* Богатые транзакции и консистентность.
* Удобные табличные отчеты и аналитика.
* Гибкая работа с версиями через SQL.

**Минусы**
* Графовые запросы сложнее (рекурсивные CTE).
* Большие глубины обходов могут быть дороже.

### 3) Гибрид: PostgreSQL + JSONB + графовое расширение (например, Apache AGE)
**Плюсы**
* Единое хранилище для связей и метаданных.
* Возможность графовых запросов без выделенной графовой БД.
* Сильные транзакции и удобная аналитика.

**Минусы**
* Зависимость от расширения и его зрелости.
* Часть графовых возможностей может быть ограничена.

## Критерии выбора
* Сложность связей и необходимость графовых запросов.
* Транзакционность и строгая консистентность.
* Производительность при смешанных графовых/табличных запросах.
* Эксплуатационные затраты и сложность поддержки.
* Гибкость схемы и работа с версиями.

## Решение
Принять **гибридный подход на базе PostgreSQL**:
* хранить сущности и связи в реляционной схеме;
* использовать **JSONB** для дополнительных метаданных и гибких фильтров;
* при необходимости сложных графовых запросов подключить расширение **Apache AGE** или аналог.

## Последствия
* Получаем единый стек с сильными транзакциями и удобной аналитикой.
* Графовые запросы можно эволюционировать от рекурсивных CTE к расширению без миграции данных.
* Нужно контролировать зрелость и поддержку выбранного расширения.
