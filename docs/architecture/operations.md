# Эксплуатационная архитектура и DevOps-практики

## Целевая инфраструктура
### Среды
- **Dev** — ежедневная разработка, быстрые итерации, упрощенные лимиты ресурсов.
- **QA/Test** — регрессионные тесты и интеграционные проверки.
- **Stage** — пред-прод среда с профилем, максимально близким к Production.
- **Prod** — боевое окружение с изоляцией, отказоустойчивостью и аудитом.

### Окружение
- **Контейнеризация**: все сервисы упакованы в контейнеры (Docker).
- **Оркестрация**: Kubernetes для масштабирования, самовосстановления и service discovery.
- **Сетевые контуры**: отдельные namespace/VPC per среда, ограничение входа через API Gateway/Ingress.
- **Данные**: отдельные базы данных по средам, автоматические бэкапы и политика восстановления.

### Стратегии выката
- **Blue/Green** для критичных сервисов с мгновенным откатом через переключение трафика.
- **Canary** для постепенного выката и оценки метрик качества.
- **Feature flags** для отключения фич без деплоя.

## CI/CD пайплайн
### Сборка
- **Сборка Docker-образов** с фиксированными версиями зависимостей.
- **Кеширование** зависимостей и слоев для ускорения сборок.

### Проверки качества
- **Unit/Integration тесты** для основных сервисов.
- **Линтеры и статический анализ** (например, ESLint/Flake8/Go vet).
- **SAST/Dependency scanning** на уязвимости и нарушения лицензий.

### Артефакты
- **Публикация образов** в приватный реестр.
- **Версионирование** по SemVer и git tag.

### Деплой
- **Автоматический деплой** в Dev/QA при каждом merge.
- **Деплой в Stage/Prod** через ручное подтверждение или релизные теги.
- **Пост-деплой проверки**: smoke-тесты, health-checks, мониторинг ключевых метрик.

## Infrastructure as Code (IaC)
- **Terraform** — описывает облачную инфраструктуру (кластеры, сети, базы, балансировщики).
- **Helm** — управляет параметризацией и установкой сервисов в Kubernetes.
- **Ansible** — для конфигурации ВМ/бастионов и системных настроек.
- **GitOps** — все изменения через pull request, история изменений хранится в репозитории.

## Автоскейлинг и политики отката
### Автоскейлинг
- **HPA по CPU/Memory** для основных сервисов.
- **Custom metrics** по latency (p95/p99) через Prometheus Adapter.
- **Queue depth** для воркеров (например, длина очереди в брокере).

### Политики аварийного отката
- **Авто-rollback** при деградации p95 latency, росте 5xx, снижении success rate.
- **Circuit breaker** для защиты downstream сервисов.
- **План восстановления**: быстрый откат, прогрев кэшей, проверка консистентности данных.

## Наблюдаемость и алерты
### Метрики
- **Prometheus** для сбора метрик.
- **Grafana** для визуализации дашбордов (SLO, error budget, latency).

### Логи
- **Structured logging** (JSON) с корреляцией по trace-id.
- **Централизованный сбор** в Elastic/Loki с ретеншном.

### Трассировка
- **OpenTelemetry** для распределенной трассировки.
- **Jaeger/Tempo** для анализа трасс.

### Алерты
- **Alertmanager** для уведомлений в Slack/Email/PagerDuty.
- Триггеры по SLO: доступность, latency, error rate, queue backlog.

---
Версия: 1.0

Последнее обновление: 2026-01-09
