# Политика версионирования данных

## 1. Тип версионирования и правила увеличения версий
Мы используем **семантическое версионирование** для доменных сущностей (SemVer: `MAJOR.MINOR.PATCH`).

Правила увеличения:
- **MAJOR** — несовместимые изменения в доменной модели или правилах расчёта, которые требуют миграции данных или пересмотра интеграций.
- **MINOR** — совместимые расширения: добавление новых атрибутов, параметров или сценариев без изменения существующих контрактов.
- **PATCH** — совместимые исправления: багфиксы, уточнения валидации, правки описаний без изменения бизнес-контрактов.

Версия увеличивается **монотонно**: значение версии новой ревизии всегда больше предыдущей для той же сущности.

## 2. Согласование с бизнес-требованиями
Данная политика отражает бизнес-ожидания:
- **Прозрачность изменений**: потребители данных и отчётности понимают масштаб изменения по номеру версии.
- **Совместимость**: изменения MINOR/PATCH не ломают существующие процессы.
- **Контроль рисков**: изменения MAJOR требуют отдельного согласования и плана миграции.

## 3. Привязка стратегии к доменным сущностям
Версионируются следующие доменные сущности:
- **Записи (records)**: бизнес-объекты, которые изменяются во времени и должны иметь историю изменений.
- **Конфигурации**: наборы правил/параметров, влияющих на поведение системы.
- **Схемы**: описания структур данных (например, форматы импорта/экспорта), где важно фиксировать совместимость.

Каждая из сущностей имеет собственную независимую историю версий.

## 4. Хранение версии в данных
Для каждой версии сущности фиксируются поля:
- `version` — строка в формате `MAJOR.MINOR.PATCH` (например, `2.3.1`).
- `revision` — целочисленная последовательность, увеличивается на 1 при каждом изменении (для удобства сортировки и ссылок).
- `effective_at` — дата и время, с которого версия считается активной.

Рекомендуемая структура записи версии:
```json
{
  "version": "2.3.1",
  "revision": 7,
  "effective_at": "2024-08-01T00:00:00Z"
}
```

## 5. История изменений (audit trail)
Для каждой доменной сущности фиксируется история изменений, чтобы можно было:
- просматривать эволюцию сущности по времени;
- сравнивать ревизии и восстанавливать состояние;
- проводить аудит изменений и контроль доступа.

Рекомендуемая структура записи истории:
```json
{
  "change_id": "c7c82754-4ee1-4b5b-94f0-cb40f0ad3aa4",
  "entity_type": "function",
  "entity_id": "f2e6e5c2-6d9a-4de6-8f4e-2f23ab1442ab",
  "revision": 7,
  "changed_at": "2024-08-01T10:15:00Z",
  "changed_by": "reviewer@company.com",
  "change_type": "update",
  "diff": {
    "status": { "from": "draft", "to": "active" }
  }
}
```

Правила:
- запись истории создаётся при любом `create/update/delete`;
- `revision` должен совпадать с ревизией сущности после изменения;
- хранить историю минимум 1 год (настраиваемо политикой).
